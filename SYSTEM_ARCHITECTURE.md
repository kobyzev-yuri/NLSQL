# Архитектура системы NL→SQL (по ТЗ)

## 🏗️ Основные компоненты системы

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                ПОЛЬЗОВАТЕЛЬ                                    │
│  ┌─────────────────┐              ┌─────────────────┐                          │
│  │   Веб-интерфейс │              │  Telegram-бот   │                          │
│  │     (React)     │              │   (опционально) │                          │
│  └─────────────────┘              └─────────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────────┘
                              │                    │
                              ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              API-СЕРВИС                                        │
│                        (Python + FastAPI)                                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                │
│  │   Прием запросов│  │  Обработка NL   │  │  Генерация SQL  │                │
│  │   от пользователя│  │   запросов      │  │   планов        │                │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                │
└─────────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            КАТАЛОГ СХЕМ                                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                │
│  │   Описание      │  │   Структура     │  │   Метаданные    │                │
│  │   таблиц        │  │   полей         │  │   БД            │                │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                │
└─────────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              LLM МОДЕЛЬ                                        │
│  ┌─────────────────┐              ┌─────────────────┐                          │
│  │     Ollama      │              │      vLLM       │                          │
│  │   (разработка)  │              │  (продакшен)    │                          │
│  │                 │              │                 │                          │
│  │ • Qwen 2.5      │              │ • Qwen 2.5      │                          │
│  │ • Llama 3.1     │              │ • Llama 3.1     │                          │
│  └─────────────────┘              └─────────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           CORE PLATFORM                                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                │
│  │   Сборка SQL    │  │  Добавление     │  │  Ролевые        │                │
│  │   из плана      │  │  служебных      │  │  ограничения    │                │
│  │   (JSON/XML)    │  │  компонентов    │  │                 │                │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                │
└─────────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            PostgreSQL                                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                │
│  │   Выполнение    │  │  Row Level      │  │   Безопасность  │                │
│  │   SQL запросов  │  │  Security       │  │   данных        │                │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                │
└─────────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              РЕЗУЛЬТАТ                                        │
│  ┌─────────────────┐              ┌─────────────────┐                          │
│  │   Таблицы       │              │    Графики      │                          │
│  │   данных        │              │   (Plotly)      │                          │
│  └─────────────────┘              └─────────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## ❓ Вопросы для уточнения

### 1. Интеграция с Core Platform
```
┌─────────────────┐    ┌─────────────────┐
│   API-СЕРВИС    │───►│ CORE PLATFORM   │
│   (FastAPI)     │    │                 │
└─────────────────┘    └─────────────────┘
```
**❓ ВОПРОС:** Как именно происходит интеграция с Core Platform?
- Это отдельный сервис или модуль внутри Core Platform?
- Какой API используется для взаимодействия?
- Как передаются ролевые ограничения?

### 2. Ролевая модель
```
┌─────────────────┐    ┌─────────────────┐
│   ПОЛЬЗОВАТЕЛЬ  │───►│   РОЛИ И        │
│                 │    │   ПРАВА         │
└─────────────────┘    └─────────────────┘
```
**❓ ВОПРОС:** Как реализована система ролей?
- Где хранятся роли пользователей?
- Как определяются права доступа?
- Как интегрируется с PostgreSQL RLS?

### 3. Каталог схем
```
┌─────────────────┐    ┌─────────────────┐
│   КАТАЛОГ       │───►│   LLM МОДЕЛЬ    │
│   СХЕМ          │    │                 │
└─────────────────┘    └─────────────────┘
```
**❓ ВОПРОС:** Как устроен каталог схем?
- Это отдельная база данных или файлы?
- Как обновляется информация о схеме?
- Какие метаданные включаются?

### 4. Telegram-бот
```
┌─────────────────┐    ┌─────────────────┐
│  TELEGRAM-БОТ   │───►│   API-СЕРВИС    │
│                 │    │                 │
└─────────────────┘    └─────────────────┘
```
**❓ ВОПРОС:** Как работает Telegram-бот?
- Это отдельное приложение или часть API-сервиса?
- Как обеспечивается безопасность для бота?
- Какие ограничения на использование персональных данных?

### 5. Безопасность
```
┌─────────────────┐    ┌─────────────────┐
│   OWASP         │    │   152-ФЗ        │
│   РЕКОМЕНДАЦИИ  │    │   СОБЛЮДЕНИЕ    │
└─────────────────┘    └─────────────────┘
```
**❓ ВОПРОС:** Как реализована безопасность?
- Какие конкретно OWASP рекомендации применяются?
- Как проверяются вредные запросы?
- Как обеспечивается соблюдение 152-ФЗ?

## 🔄 Поток данных

```
Пользователь → API-Сервис → Каталог схем → LLM → Core Platform → PostgreSQL → Результат
     ↑                                                                              │
     └─────────────────────── Обратная связь ──────────────────────────────────────┘
```

## 📋 Компоненты для реализации

### ✅ Что понятно из ТЗ:
- [x] API-сервис на Python + FastAPI
- [x] LLM модель (Ollama/vLLM) с Qwen 2.5/Llama 3.1
- [x] PostgreSQL с Row Level Security
- [x] React фронтенд
- [x] Telegram-бот (опционально)

### ❓ Что нужно уточнить:
- [ ] Архитектура Core Platform
- [ ] Система ролей и прав
- [ ] Структура каталога схем
- [ ] Интеграция компонентов
- [ ] Безопасность и валидация




