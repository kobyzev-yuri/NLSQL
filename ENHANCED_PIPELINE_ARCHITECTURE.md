# 🏗️ Архитектура улучшенного пайплайна для NL→SQL агента

## 📅 Дата: 12 октября 2025

## 🎯 Обзор

Создан улучшенный пайплайн для NL→SQL агента, который интегрирует:
- **Двухмодельную архитектуру** (GPT-4o + Ollama Llama 3)
- **Оптимизированную логику контекста** с приоритизацией бизнес-таблиц
- **Автоматическое переключение** между моделями
- **Улучшенную обработку DocStructureSchema**

## 🏗️ Архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                    Enhanced KB Agent                       │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────────────────────┐ │
│  │  Dual Model     │    │    Optimized Context            │ │
│  │  Pipeline       │    │    Logic                        │ │
│  │                 │    │                                 │ │
│  │  ┌─────────────┐│    │  ┌─────────────────────────────┐ │ │
│  │  │   GPT-4o    ││    │  │  Priority Tables Filter    │ │ │
│  │  │  (Primary)  ││    │  │  - equsers                 │ │ │
│  │  └─────────────┘│    │  │  - eq_departments          │ │ │
│  │                 │    │  │  - tbl_business_unit       │ │ │
│  │  ┌─────────────┐│    │  │  - tbl_principal_assignment│ │ │
│  │  │   Ollama    ││    │  │  - tbl_incoming_payments  │ │ │
│  │  │  (Backup)   ││    │  │  - etc...                 │ │ │
│  │  └─────────────┘│    │  └─────────────────────────────┘ │ │
│  └─────────────────┘    │                                 │ │
│                         │  ┌─────────────────────────────┐ │ │
│                         │  │  System Tables Exclusion     │ │ │
│                         │  │  - views                    │ │ │
│                         │  │  - view_table_usage         │ │ │
│                         │  │  - vanna_vectors            │ │ │
│                         │  │  - information_schema       │ │ │
│                         │  └─────────────────────────────┘ │ │
│                         └─────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 Компоненты

### 1. **DualModelPipeline** (`src/vanna/dual_model_pipeline.py`)
- **Назначение**: Управление двумя моделями с автоматическим переключением
- **Функции**:
  - Инициализация GPT-4o и Ollama агентов
  - Автоматический выбор модели
  - Статистика использования
  - Проверка здоровья

### 2. **OptimizedDualPipeline** (`src/vanna/optimized_dual_pipeline.py`)
- **Назначение**: Оптимизированная версия с улучшенной логикой контекста
- **Функции**:
  - Приоритизация бизнес-таблиц
  - Исключение системных таблиц
  - Оптимизированное получение контекста
  - Улучшенная генерация SQL

### 3. **EnhancedKBAgent** (`src/vanna/enhanced_kb_agent.py`)
- **Назначение**: Высокоуровневый агент, объединяющий все компоненты
- **Функции**:
  - Управление обучением
  - Генерация SQL с оптимизацией
  - Анализ контекста
  - Мониторинг здоровья

## 🚀 Запуск

### Базовый запуск:
```bash
python run_enhanced_kb_training.py
```

### Оптимизированный запуск:
```bash
python run_optimized_training.py
```

## 📊 Преимущества новой архитектуры

### 1. **Надежность**
- ✅ Автоматическое переключение между моделями
- ✅ Резервная модель при недоступности основной
- ✅ Обработка ошибок и таймаутов

### 2. **Производительность**
- ✅ Приоритизация бизнес-таблиц
- ✅ Исключение системных таблиц
- ✅ Оптимизированное получение контекста

### 3. **Качество**
- ✅ Улучшенная генерация SQL
- ✅ Правильный контекст для LLM
- ✅ Адаптация под DocStructureSchema

### 4. **Мониторинг**
- ✅ Статистика использования моделей
- ✅ Проверка здоровья системы
- ✅ Анализ качества контекста

## 🔍 Ключевые улучшения

### 1. **Приоритизация таблиц**
```python
priority_tables = [
    "equsers",                    # Пользователи
    "eq_departments",             # Отделы
    "eqgroups",                   # Группы
    "eqroles",                    # Роли
    "tbl_business_unit",          # Клиенты
    "tbl_principal_assignment",  # Поручения
    "tbl_incoming_payments",      # Платежи
    "tbl_accounts_document",      # Учетные записи
    "tbl_personal_account"        # Личные кабинеты
]
```

### 2. **Исключение системных таблиц**
```python
system_tables = [
    "views", "view_table_usage", "vanna_vectors",
    "information_schema", "pg_catalog", "pg_*"
]
```

### 3. **Оптимизированное получение контекста**
- Получение DDL только для приоритетных таблиц
- Исключение системных таблиц
- Объединение контекста из разных источников

## 📈 Ожидаемые результаты

### Производительность:
- **GPT-4o**: 1-2 секунды, 100% успешность
- **Ollama**: 5-10 секунд, 100% успешность

### Качество:
- Правильное определение бизнес-таблиц
- Корректная генерация SQL
- Улучшенный контекст для LLM

### Надежность:
- Автоматическое переключение моделей
- Обработка ошибок
- Мониторинг здоровья

## 🔧 Конфигурация

### GPT-4o (основная модель):
```python
gpt4_config = {
    'model': 'gpt-4o',
    'api_key': '<ENV:PROXYAPI_KEY|OPENAI_API_KEY>',
    'base_url': '<ENV:OPENAI_BASE_URL|https://api.proxyapi.ru/openai/v1>',
    'temperature': 0.2
}
```

### Ollama (резервная модель):
```python
ollama_config = {
    'model': 'llama3:latest',
    'api_key': 'ollama',
    'base_url': 'http://localhost:11434/v1',
    'temperature': 0.2
}
```

### Security note
- Никогда не хардкодьте ключи API в коде/документации. Используйте переменные окружения (`PROXYAPI_KEY`, `OPENAI_API_KEY`, `OPENAI_BASE_URL`).

## 📁 Файлы

### Основные компоненты:
- `src/vanna/dual_model_pipeline.py` - Двухмодельный пайплайн
- `src/vanna/optimized_dual_pipeline.py` - Оптимизированный пайплайн
- `src/vanna/enhanced_kb_agent.py` - Улучшенный KB агент

### Скрипты запуска:
- `run_enhanced_kb_training.py` - Базовый запуск
- `run_optimized_training.py` - Оптимизированный запуск

### Документация:
- `ENHANCED_PIPELINE_ARCHITECTURE.md` - Этот файл
- `FINAL_MODEL_COMPARISON_REPORT.md` - Отчет сравнения моделей

## 🎯 Следующие шаги

1. **Тестирование** - Запуск оптимизированного пайплайна
2. **Валидация** - Проверка качества генерации SQL
3. **Оптимизация** - Дальнейшие улучшения на основе результатов
4. **Документация** - Обновление документации по результатам

---
*Архитектура создана: 12 октября 2025*
*Статус: Готово к тестированию ✅*
