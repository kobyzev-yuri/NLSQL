# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö SQL

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–µ—Ä–µ–¥–∞—á–∏ SQL –¥–∞–Ω–Ω—ã—Ö

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Vanna AI    ‚îÇ  –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL –∏–∑ NL
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FastAPI (simple_web_interface.py)       ‚îÇ
‚îÇ  1. –ü–æ–ª—É—á–∞–µ—Ç SQL –æ—Ç Vanna AI              ‚îÇ
‚îÇ  2. –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–ª—è PostgreSQL   ‚îÇ
‚îÇ  3. –ü–µ—Ä–µ–¥–∞–µ—Ç –≤ Mock API                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Mock API (mock_customer_api.py)         ‚îÇ
‚îÇ  1. –ü–æ–ª—É—á–∞–µ—Ç SQL                          ‚îÇ
‚îÇ  2. –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ä–æ–ª–µ–≤—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è         ‚îÇ
‚îÇ  3. –í—ã–ø–æ–ª–Ω—è–µ—Ç SQL                         ‚îÇ
‚îÇ  4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  UI (Streamlit / simple_web_interface)   ‚îÇ
‚îÇ  –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤—Å–µ —ç—Ç–∞–ø—ã SQL                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –æ—Ç–≤–µ—Ç–µ API

### –û—Ç Mock API –∫ FastAPI

```json
{
  "success": true,
  "sql_template": "SELECT * FROM ... WHERE ...",  // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π SQL (–∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª—É—á–∏–ª Mock API)
  "sql_with_roles": "SELECT * FROM ... WHERE ... AND owner_id = '...'",  // SQL —Å —Ä–æ–ª—è–º–∏
  "final_sql": "SELECT * FROM ... WHERE ... AND owner_id = '...'",  // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  "data": [...],
  "columns": [...],
  "row_count": 10,
  "execution_time": 0.15,
  "user_context": {...},
  "restrictions_applied": [...]
}
```

### –û—Ç FastAPI –∫ UI

```json
{
  "success": true,
  "sql_template": "SELECT * FROM ...",  // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π SQL –æ—Ç Vanna AI (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π)
  "sql_corrected": "SELECT * FROM ...",  // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π SQL (–ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ Mock API)
  "sql_with_roles": "SELECT * FROM ... AND owner_id = '...'",  // SQL —Å —Ä–æ–ª—è–º–∏
  "sql": "SELECT * FROM ... AND owner_id = '...'",  // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  "final_sql": "SELECT * FROM ... AND owner_id = '...'",  // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  "data": [...],
  "columns": [...],
  "row_count": 10,
  "execution_time": 0.15,
  "restrictions": [...],
  "explanation": "...",
  "agent_type": "QueryService —Å KB + Mock API"
}
```

## –≠—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ SQL

### 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL (Vanna AI)

**–ü—Ä–∏–º–µ—Ä:**
```sql
SELECT *
FROM tbl_principal_assignment
WHERE creationdatetime >= NOW() - INTERVAL "1 month";
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –î–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤–º–µ—Å—Ç–æ –æ–¥–∏–Ω–∞—Ä–Ω—ã—Ö
- –ê–ª–∏–∞—Å—ã —Ç–∞–±–ª–∏—Ü
- JOIN –≤–º–µ—Å—Ç–æ LEFT JOIN

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SQL (FastAPI)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```python
# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å PostgreSQL
sql = sql.replace('"7 days"', "'7 days'")
sql = sql.replace('"1 month"', "'1 month'")

# –£–±–∏—Ä–∞–µ–º –∞–ª–∏–∞—Å—ã —Ç–∞–±–ª–∏—Ü
sql = sql.replace('ti.', '')
sql = sql.replace('pa.', '')

# –ó–∞–º–µ–Ω—è–µ–º JOIN –Ω–∞ LEFT JOIN
sql = re.sub(r'JOIN\s+(eq_)?departments', r'LEFT JOIN \1departments', sql)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```sql
SELECT *
FROM tbl_principal_assignment
WHERE creationdatetime >= NOW() - INTERVAL '1 month';
```

### 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–µ–π (Mock API)

**–†–æ–ª–∏:**
- **admin**: –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
- **manager**: –î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º —Å–≤–æ–µ–≥–æ –æ—Ç–¥–µ–ª–∞
- **user**: –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ —Å–≤–æ–∏–º –¥–∞–Ω–Ω—ã–º

**–ü—Ä–∏–º–µ—Ä –¥–ª—è —Ä–æ–ª–∏ `user`:**
```sql
SELECT *
FROM tbl_principal_assignment
WHERE creationdatetime >= NOW() - INTERVAL '1 month'
  AND owner_id = '1acae6e0-7808-4f87-9829-8b7fc0b4f98f';
```

## –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ UI

### simple_web_interface (HTML)

```html
<h4>üìã SQL –®–∞–±–ª–æ–Ω (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç Vanna AI):</h4>
<pre>${data.sql_template}</pre>

<h4>üîß SQL –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π (–ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ Mock API):</h4>
<pre>${data.sql_corrected}</pre>

<h4>üîê SQL —Å —Ä–æ–ª–µ–≤—ã–º–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏:</h4>
<pre>${data.sql_with_roles}</pre>
```

### Streamlit

```python
st.markdown("### üìã SQL –®–∞–±–ª–æ–Ω (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç Vanna AI)")
st.code(result.get('sql_template', ''), language='sql')

st.markdown("### üîß SQL –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π (–ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ Mock API)")
st.code(result.get('sql_corrected', ''), language='sql')

st.markdown("### üîê SQL —Å —Ä–æ–ª–µ–≤—ã–º–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏")
st.code(result.get('sql_with_roles', ''), language='sql')
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–∞–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

1. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å**: –í–∏–¥–Ω—ã –≤—Å–µ —ç—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ SQL
2. **–û—Ç–ª–∞–¥–∫–∞**: –õ–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
3. **–û–±—É—á–µ–Ω–∏–µ**: –ü–æ–Ω—è—Ç–Ω–æ, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –í–∏–¥–Ω–æ, –∫–∞–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

## –ù–µ–ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–æ—Å—Ç—å

- `sql_template` –≤—Å–µ–≥–¥–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π SQL –æ—Ç Vanna AI
- `sql_corrected` –≤—Å–µ–≥–¥–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π SQL (–ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ Mock API)
- `sql_with_roles` –≤—Å–µ–≥–¥–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π SQL —Å —Ä–æ–ª—è–º–∏ (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –ë–î)
- –ö–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –≤ —Å–≤–æ–µ–º —Å–ª–æ–µ –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –¥–∞–ª—å—à–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π







