# Требования к полноте и качеству схемы данных для NL→SQL (для заказчика)

Цель: обеспечить стабильную генерацию корректного SQL и ответов по бизнес‑процессам (в т.ч. платежи) за счёт согласованной схемы и доменной документации.

## Текущее состояние (что обнаружили у нас)
- В живой БД присутствуют платежные таблицы (например, `public.tbl_incoming_payments`, `public.tbl_payment_statuses`).
- В DocStructureSchema JSON/XML платежные сущности либо отсутствуют, либо названы иначе (нет прямого соответствия именам БД).
- Из‑за расхождения документации и БД агенту не хватает контекста: он не уверен в таблицах/полях и отказывается генерировать SQL по платежам.
- Мы вынуждены усиливать базу знаний (RAG) данными из живой БД, что увеличивает время на внедрение.

Что просим:
- Синхронизировать DocStructureSchema с живой БД (включая платежные таблицы и их поля).
- Предоставить словари/справочники и примеры Q/A по платежным сценариям.

## 1) Актуальная и согласованная схема
- Единая версия: JSON/XML (DocStructureSchema) синхронизированы с живой БД (PostgreSQL).
- Версионирование: номер версии схемы и дата выгрузки; список изменений относительно предыдущей версии.
- Схемы БД: явное указание schema (напр. `public`), регистр имён (UPPER/lower), алиасы/синонимы/VIEW.

## 2) Полный словарь таблиц и колонок
Для каждой ключевой таблицы (например, `public.tbl_incoming_payments`):
- Назначение и краткое бизнес‑описание.
- Колонки: имя, тип (UUID/int/decimal/text/boolean/timestamp), nullable, default.
- Семантика полей: расшифровка (`payment_status`, `payment_date`, `amount_payment_rubles`, `business_unit_id`).
- Ограничения: PK/FK/UNIQUE/CHECK, индексы и их назначение.
- Примеры значений (2–3 строки, обезличенные при необходимости).

## 3) Связи и кардинальности (ER)
- Диаграмма/перечень PK→FK с кардинальностями (1–1, 1–N, N–M).
- Ключевые JOIN для сценариев: платеж → контрагент/бизнес‑единица → отдел/менеджер.

## 4) Доменные справочники и статусы
- Перечень справочников (напр. `tbl_payment_statuses`, `tbl_postpayment_types`).
- Для каждого — допустимые значения/коды и человекочитаемые расшифровки.
- Бизнес‑правила переходов статусов (жизненный цикл).

## 5) Маппинг «бизнес‑сущность ↔ таблицы/поля»
- Users, Departments, Assignments, Payments, Clients/Business Units — где лежат и как связаны.
- Если имена в документации отличаются от БД — приложить таблицу соответствий (алиасы) для каждого объекта.

## 6) Ролевые правила доступа (RLS)
- Описание ролей: admin/manager/user (или фактические роли).
- Ограничения на уровне строк/полей: «свой отдел», «свои данные», исключения.
- Примеры ролевых фильтров в SQL‑выражениях.

## 7) Эталонные бизнес‑вопросы и проверенные SQL (Q/A)
Минимум 20–30 примеров по ключевым процессам, включая платежи:
- Вопрос на естественном языке + корректный SQL.
- Пояснение по таблицам/связям и ожидаемому результату.
- Варианты с периодами (7/30/90 дней), агрегатами и статусами.

## 8) Экспорт/доступ к данным для валидации
- Дамп БД (или доступ только для чтения) с согласованной схемой.
- Гарантия ненулевых таблиц в области платежей.
- Таймзона и формат дат/денег.

## 9) Качество и контроль изменений
- Чек‑лист перед релизом схемы: ER‑валидация, описания колонок, сопоставление алиасов.
- Регламент изменения схемы: changelog, уведомление, обратная совместимость.

## 10) Формат поставки
- Каталог `DocStructureSchema/` с JSON/XML и индексным README по содержимому.
- Отдельный файл с маппингом имен (документация ↔ БД) и ролями/RLS.
- Каталог `examples/` с эталонными Q/A (NL→SQL) по приоритетным процессам (в т.ч. платежи).

---
Минимальный «быстрый старт» по платежам:
- Подтвердить реальные таблицы: `public.tbl_incoming_payments`, `public.tbl_payment_statuses` (+ связи).
- Дать словарь ключевых полей: `payment_date`, `payment_status`, `amount_payment_rubles`, `business_unit_id`.
- Приложить 10–15 Q/A по платежам (периоды/статусы/топ‑N/по отделам) + 2–3 строки примеров (обезличенных).
