# Архитектура NL→SQL системы с интеграцией Vanna AI

## 🎯 **Обновленная архитектура решения**

### **Основные компоненты:**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                ПОЛЬЗОВАТЕЛЬ                                    │
│  ┌─────────────────┐              ┌─────────────────┐                          │
│  │   Веб-интерфейс │              │  Telegram-бот   │                          │
│  │   (заказчик)    │              │   (опционально) │                          │
│  └─────────────────┘              └─────────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────────┘
                              │                    │
                              ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              FASTAPI СЕРВЕР                                    │
│                        (Наш NL→SQL агент)                                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                │
│  │   Прием запросов│  │  Vanna AI       │  │  Генерация SQL  │                │
│  │   от пользователя│  │  RAG модель     │  │   шаблонов      │                │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                │
└─────────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            ВЕКТОРНАЯ БАЗА                                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                │
│  │   ChromaDB      │  │   PostgreSQL    │  │   FAISS         │                │
│  │   (рекоменд.)   │  │   pgvector     │  │   (альтернатива) │                │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                │
└─────────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           API ЗАКАЗЧИКА                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                │
│  │   Получение     │  │  Добавление     │  │  Выполнение     │                │
│  │   SQL шаблона   │  │  ролевых        │  │  SQL в          │                │
│  │                 │  │  ограничений    │  │  PostgreSQL     │                │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                │
└─────────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            PostgreSQL                                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                │
│  │   DocStructure   │  │  Row Level     │  │   Результаты    │                │
│  │   Schema         │  │  Security      │  │   запросов      │                │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 🔧 **Технологический стек**

### **Backend (FastAPI + Vanna AI):**
- **FastAPI** - REST API сервер
- **Vanna AI** - RAG модель для генерации SQL
- **ChromaDB** - векторная база данных (рекомендуется)
- **PostgreSQL** - основная база данных
- **SQLAlchemy** - ORM для работы с БД
- **Pydantic** - валидация данных

### **LLM интеграция:**
- **OpenAI GPT-4** (рекомендуется)
- **Ollama** (локальная альтернатива)
- **Anthropic Claude** (альтернатива)

### **Векторные базы данных:**
- **ChromaDB** - простая настройка
- **PostgreSQL pgvector** - интеграция с основной БД
- **FAISS** - высокая производительность

## 📋 **План реализации**

### **Этап 1: Настройка проекта**
1. ✅ Анализ структуры PostgreSQL базы DocStructureSchema
2. ✅ Загрузка тестовой базы данных
3. 🔄 Интеграция Vanna AI
4. 🔄 Настройка векторной базы данных
5. 🔄 Создание FastAPI сервера

### **Этап 2: Обучение Vanna AI**
1. 🔄 Создание каталога схем на русском языке
2. 🔄 Обучение модели на DDL структуре
3. 🔄 Добавление примеров SQL запросов
4. 🔄 Тестирование генерации SQL

### **Этап 3: API интеграция**
1. 🔄 Создание эндпоинтов FastAPI
2. 🔄 Интеграция с API заказчика
3. 🔄 Обработка ролевых ограничений
4. 🔄 Возврат результатов

### **Этап 4: Тестирование и оптимизация**
1. 🔄 Тестирование простых запросов
2. 🔄 Тестирование сложных запросов
3. 🔄 Оптимизация производительности
4. 🔄 Документация API

## 🚀 **Следующие шаги**

### **1. Установка зависимостей**
```bash
pip install vanna fastapi uvicorn sqlalchemy psycopg2-binary chromadb
```

### **2. Настройка Vanna AI**
```python
from vanna.openai.openai_chat import OpenAI_Chat
from vanna.chromadb.chromadb_vector import ChromaDB_VectorStore

class DocStructureVanna(ChromaDB_VectorStore, OpenAI_Chat):
    def __init__(self, config=None):
        ChromaDB_VectorStore.__init__(self, config=config)
        OpenAI_Chat.__init__(self, config=config)
```

### **3. Обучение модели**
```python
# DDL структура
vn.train(ddl="CREATE TABLE equsers (id UUID PRIMARY KEY, login VARCHAR, email VARCHAR)")

# Документация
vn.train(documentation="equsers - таблица пользователей системы")

# Примеры SQL
vn.train(sql="SELECT login, email FROM equsers WHERE department = 'IT'")
```

### **4. FastAPI сервер**
```python
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI()

class QueryRequest(BaseModel):
    question: str
    user_id: str
    role: str

@app.post("/query")
async def process_query(request: QueryRequest):
    # Генерация SQL через Vanna AI
    sql = vn.ask(request.question)
    
    # Отправка в API заказчика
    # Получение результата
    # Возврат пользователю
```

## 📊 **Преимущества Vanna AI**

### **1. RAG подход:**
- ✅ Портабельность между LLM
- ✅ Легкое удаление устаревших данных
- ✅ Дешевле чем fine-tuning
- ✅ Будущее-ориентированность

### **2. Безопасность:**
- ✅ Содержимое БД не отправляется в LLM
- ✅ SQL выполняется локально
- ✅ Приватность данных

### **3. Самообучение:**
- ✅ Автообучение на успешных запросах
- ✅ Обратная связь от пользователей
- ✅ Улучшение точности со временем

## 🎯 **Интеграция с заказчиком**

### **API контракт:**
```json
{
  "sql_template": "SELECT * FROM equsers WHERE department = ?",
  "parameters": ["IT"],
  "user_context": {
    "user_id": "123",
    "role": "manager",
    "department": "IT"
  }
}
```

### **Ответ API заказчика:**
```json
{
  "final_sql": "SELECT * FROM equsers WHERE department = 'IT' AND user_id = '123'",
  "result": [...],
  "execution_time": "0.05s"
}
```

## 📝 **Документация проекта**

### **Структура файлов:**
```
sql4A/
├── src/
│   ├── api/           # FastAPI эндпоинты
│   ├── models/        # Pydantic модели
│   ├── services/      # Бизнес-логика
│   └── vanna/         # Vanna AI интеграция
├── docs/              # Документация
├── tests/             # Тесты
├── requirements.txt   # Зависимости
└── README.md         # Описание проекта
```

## ✅ **Готовность к реализации**

- ✅ Архитектура определена
- ✅ Технологический стек выбран
- ✅ База данных загружена и проанализирована
- ✅ Vanna AI изучен
- 🔄 Готов к началу реализации
